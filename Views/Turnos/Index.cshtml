@model IEnumerable<GestionDeTurnos.Web.Models.Turn>

@{
    ViewData["Title"] = "Panel de Turnos";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-4">Panel de Funcionario</h1>
        <div>
            <a asp-action="Siguiente" class="btn btn-success btn-lg">‚û°Ô∏è Llamar Siguiente</a>
            <a asp-action="Reiniciar" class="btn btn-danger btn-lg">üîÑ Reiniciar Turnos</a>
        </div>
    </div>

    @if (TempData["MensajeError"] != null)
    {
        <div class="alert alert-warning" role="alert">
            @TempData["MensajeError"]
        </div>
    }
    @if (TempData["MensajeExito"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["MensajeExito"]
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-header">
            <h2 class="h5 mb-0">Historial de Turnos</h2>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">N√∫mero</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Caja</th>
                        <th scope="col">Creado</th>
                        <th scope="col">Llamado</th>
                    </tr>
                </thead>
                <tbody id="tabla-turnos">
                    @foreach (var t in Model)
                    {
                        <tr>
                            <td><span class="badge bg-primary rounded-pill fs-6">@t.Number</span></td>
                            <td>@t.Status</td>
                            <td>@t.BoxId</td>
                            <td>@t.CreatedAt.ToLocalTime()</td>
                            <td>@t.CalledAt?.ToLocalTime()</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/turnoshub")
            .build();

        connection.on("ActualizarTurnos", () => {
            location.reload();
        });

        connection.start().catch(err => console.error(err.toString()));
    </script>
}