@model GestionDeTurnos.Web.Models.Affiliate

@{
    ViewData["Title"] = "Registrar Afiliado";
}

<div class="row align-items-center mb-4">
    <div class="col">
        <h1 class="h3 mb-0 text-dark fw-bold">
            <i class="bi bi-person-plus-fill me-2 text-primary"></i>Registrar Nuevo Afiliado
        </h1>
        <p class="text-muted small mb-0">Completa el formulario para registrar un nuevo afiliado.</p>
    </div>
    <div class="col-auto">
        <a asp-action="Index" class="btn btn-light border shadow-sm">
            <i class="bi bi-arrow-left me-1"></i> Volver a la lista
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white py-3 border-bottom">
                <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-person-lines-fill me-2"></i>Datos Personales</h6>
            </div>
            <div class="card-body p-4">
                <form asp-action="Crear" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4 rounded-3" role="alert"></div>
                    <input type="hidden" id="fotoData" name="fotoData" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="FirstName" class="form-label text-secondary small text-uppercase fw-bold">Nombres</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                                <input asp-for="FirstName" class="form-control border-start-0 ps-2" placeholder="Ej: Maria Elena" />
                            </div>
                            <span asp-validation-for="FirstName" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="LastName" class="form-label text-secondary small text-uppercase fw-bold">Apellidos</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-people"></i></span>
                                <input asp-for="LastName" class="form-control border-start-0 ps-2" placeholder="Ej: Gonzalez" />
                            </div>
                            <span asp-validation-for="LastName" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="DocumentNumber" class="form-label text-secondary small text-uppercase fw-bold">DNI / Documento</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-card-heading"></i></span>
                                <input asp-for="DocumentNumber" class="form-control border-start-0 ps-2" />
                            </div>
                            <span asp-validation-for="DocumentNumber" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Email" class="form-label text-secondary small text-uppercase fw-bold">Email</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                                <input asp-for="Email" class="form-control border-start-0 ps-2" placeholder="ejemplo@email.com" />
                            </div>
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-md-6">
                             <label asp-for="Phone" class="form-label text-secondary small text-uppercase fw-bold">Teléfono</label>
                             <div class="input-group">
                                 <span class="input-group-text bg-light border-end-0"><i class="bi bi-telephone"></i></span>
                                 <input asp-for="Phone" class="form-control border-start-0 ps-2" />
                             </div>
                             <span asp-validation-for="Phone" class="text-danger small"></span>
                        </div>

                        <div class="col-12 mt-4 pt-3 border-top d-flex justify-content-end gap-2">
                             <a asp-action="Index" class="btn btn-outline-secondary">Cancelar</a>
                             <button type="submit" class="btn btn-success px-4 shadow-sm">
                                 <i class="bi bi-check-lg me-2"></i>Registrar
                             </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel de Foto -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-camera me-2"></i>Foto de Perfil</h6>
            </div>
            <div class="card-body text-center p-4">
                
                <div class="bg-dark rounded-3 overflow-hidden mb-3 shadow-sm position-relative" id="camara-container" style="min-height: 240px;">
                    <video id="video" width="100%" height="auto" autoplay muted style="transform: scaleX(-1); border-radius: 8px;"></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-danger animate-pulse">REC</span>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-3">
                    <button id="capturar" class="btn btn-primary rounded-pill"><i class="bi bi-camera-fill me-2"></i>Capturar Foto</button>
                </div>

                <div id="foto-preview-container" class="mt-3 p-3 bg-light rounded border" style="display:none;">
                    <p class="small text-muted fw-bold text-start mb-2">Vista Previa:</p>
                    <img id="foto-preview" class="img-fluid rounded shadow-sm mb-3 w-100" />
                    <button id="borrar-foto" class="btn btn-outline-danger btn-sm w-100"><i class="bi bi-trash me-2"></i>Tomar de Nuevo</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const capturarBtn = document.getElementById('capturar');
        const fotoDataInput = document.getElementById('fotoData');
        const fotoPreview = document.getElementById('foto-preview');
        const fotoPreviewContainer = document.getElementById('foto-preview-container');
        const borrarFotoBtn = document.getElementById('borrar-foto');
        const camaraContainer = document.getElementById('camara-container');

        // Acceder a la cámara
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true }).then(function (stream) {
                video.srcObject = stream;
                video.play();
            }).catch(function(err) {
                console.error("Error: " + err);
                alert("No se pudo acceder a la cámara. Revisa los permisos.");
            });
        }

        // Capturar foto
        capturarBtn.addEventListener("click", function (e) {
            e.preventDefault();
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            let dataURL = canvas.toDataURL('image/jpeg');
            fotoDataInput.value = dataURL;
            fotoPreview.src = dataURL;
            
            fotoPreviewContainer.style.display = 'block';
            camaraContainer.style.display = 'none';
            capturarBtn.style.display = 'none';
        });

        // Borrar foto y reactivar cámara
        borrarFotoBtn.addEventListener("click", function(e) {
            e.preventDefault();
            fotoDataInput.value = "";
            fotoPreview.src = "";
            fotoPreviewContainer.style.display = 'none';
            camaraContainer.style.display = 'block';
            capturarBtn.style.display = 'block';
        });
    </script>
}
